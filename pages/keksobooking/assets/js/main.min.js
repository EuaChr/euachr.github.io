"use strict";window.util={onEscPress:function(e,t){27===e.keyCode&&t()},debounce:function(e){let t;return function(){let n=arguments;t&&window.clearTimeout(t),t=window.setTimeout((function(){e.apply(null,n)}),100)}}},window.backend={load:function(e,t){},save:function(e,t,n){}},window.backend.load=function(e,t){let n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.open("GET","https://js.dump.academy/keksobooking/data"),n.send()},window.backend.save=function(e,t,n){let o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t(o.response):n(o)})),o.open("POST","https://js.dump.academy/keksobooking"),o.send(e)},function(){let e=[];window.onLoad=function(t){e=t},window.onError=function(e){console.log("Ошибка загрузки данных: "+e)},window.backend.load(window.onLoad,window.onError);const t={main:{type:"",priceRange:"",rooms:"",guests:""},minor:[],reset:function(){}},n=function(e){this.selector=e,this.value=""};n.prototype._setValue=function(e){this.value=e.value},n.prototype._getElement=function(){return document.querySelector(this.selector)},n.prototype._onValueChange=function(e){};const o=new n("#housing-type");o._onValueChange=function(n){t.main.type=n.target.value,m(e)};const r=o._getElement();t.main.type=r.value,r.addEventListener("change",o._onValueChange);const i=new n("#housing-price");i._getPriceRange=function(e){return"any"===t.main.priceRange?"any":+e<1e4?"low":+e>5e4?"high":"middle"},i._onValueChange=function(n){t.main.priceRange=n.target.value,m(e)};const c=i._getElement();t.main.priceRange=c.value,c.addEventListener("change",i._onValueChange);const s=new n("#housing-rooms");s._onValueChange=function(n){const o=n.target.value;t.main.rooms="any"===o?"any":+o,m(e)};const a=s._getElement();t.main.rooms=a.value,a.addEventListener("change",s._onValueChange);const u=new n("#housing-guests");u._onValueChange=function(n){const o=n.target.value;t.main.guests="any"===o?"any":+o,m(e)};const d=u._getElement();t.main.guests=d.value,d.addEventListener("change",u._onValueChange);const l=document.querySelector(".features");let f;const p=function(){f=l.querySelectorAll("input:checked"),t.minor=[],f.length>0&&f.forEach(e=>{t.minor.push(e.value)})};p(),l.addEventListener("change",()=>{p(),m(e)}),t.reset=function(){t.main.type=r.value,t.main.priceRange=c.value,t.main.rooms=a.value,t.main.guests=d.value,t.minor=[]};const m=window.util.debounce((function(){window.card.delete();let n=e.slice().filter(e=>{let n;return e.offer.priceRange=i._getPriceRange(e.offer.price),(n=function(e){let n;for(let o in t.main)if(!(n="any"===t.main[o]||t.main[o]===e.offer[o]))break;return n}(e))&&(n=function(e){let n=!0;for(let o=0,r=t.minor.length;o<r&&(!(r>0)||(n=e.offer.features.indexOf(t.minor[o])>=0));o++);return n}(e)),n});window.pin.render(n)}));window.filter={update:m,reset:function(){document.querySelector(".map__filters").reset(),t.reset()}}}(),function(){const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),n={able:function(){e.classList.remove("map--faded"),window.filter.update()},disable:function(){e.classList.add("map--faded")}},o={defaultPosition:{},size:{},coords:{}};o.defaultPosition={_left:"50%",_top:"375px",_resetPosition:function(){t.style.left=o.defaultPosition._left,t.style.top=o.defaultPosition._top}},o.size={_width:65,_height:51,_tailHeight:22},o.coords={startX:"",startY:"",currentX:"",currentY:"",_constraints:{left:0,top:130,right:"",bottom:630},_setX:function(e){e>=this._constraints.left&&e<=this._constraints.right?this.currentX=e:e<=this._constraints.left?this.currentX=this._constraints.left:e>=this._constraints.right&&(this.currentX=this._constraints.right)},_setY:function(e){e>=this._constraints.top&&e<=this._constraints.bottom?this.currentY=e:e<=this._constraints.top?this.currentY=this._constraints.top:e>=this._constraints.bottom&&(this.currentY=this._constraints.bottom)},_rewriteStartCoords:function(e){o.coords.startX=e.clientX,o.coords.startY=e.clientY}};const r=document.body.clientWidth;o.coords._constraints.left=Math.floor(o.size._width/2),o.coords._constraints.right=Math.floor(r-o.size._width/2);const i=document.querySelector("#address"),c={_startX:"",_startY:"",currentX:"",currentY:"",countX:function(e){return Math.floor(e+o.size._width/2)},countY:function(e){return Math.floor(e+o.size._height+o.size._tailHeight)},setCurrent:function(){i.value=this.currentX+", "+this.currentY},setDefault:function(){i.value=this._startX+", "+this._startY}};function s(e){const n=o.coords.startX-e.clientX,r=o.coords.startY-e.clientY;o.coords._rewriteStartCoords(e),o.coords.currentX=t.offsetLeft-n,o.coords.currentY=t.offsetTop-r,o.coords._setX(o.coords.currentX),o.coords._setY(o.coords.currentY),t.style.left=o.coords.currentX+"px",t.style.top=o.coords.currentY+"px",c.currentX=c.countX(o.coords.currentX),c.currentY=c.countX(o.coords.currentY),c.setCurrent()}function a(e){e.preventDefault(),n.able(),window.form.able(),window.filter.update(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",a)}c._startX=Math.floor(r/2),c._startY=c.countY(+o.defaultPosition._top.slice(0,3)),c.setDefault(),t.addEventListener("mousedown",(function(e){o.coords._rewriteStartCoords(e),document.addEventListener("mousemove",s),document.addEventListener("mouseup",a)})),window.resetMainPin=function(){o.defaultPosition._resetPosition(),c.setDefault()}}(),function(){let e=document.querySelector(".notice__form");window.uploadFiles={avatar:"",photos:[]};const t=e.querySelector(".notice__photo img"),n=e.querySelector(".notice__photo .drop-zone"),o=e.querySelector(".notice__photo input[type=file]"),r=["png","jpeg","jpg","gif"],i={on:["dragenter","dragover"],out:["dragleave","drop"]},c=function(e){e.classList.add("highlight")},s=function(e){e.classList.remove("highlight")},a=function(e){e.preventDefault(),e.stopPropagation()},u=function(e){if(d(e)){const n=new FileReader;n.addEventListener("load",(function(){t.src=n.result})),n.readAsDataURL(e)}},d=function(e){const t=e.name.toLowerCase();return r.some(e=>t.endsWith(e))};o.addEventListener("change",(function(){const e=o.files[0];window.uploadFiles.avatar=e,u(e)}));for(let e in i)i[e].forEach(e=>{n.addEventListener(e,a)});i.on.forEach(e=>{n.addEventListener(e,(function(){c(n)}))}),i.out.forEach(e=>{n.addEventListener(e,(function(){s(n)}))}),n.addEventListener("drop",(function(e){const t=e.dataTransfer.files[0];window.uploadFiles.avatar=t,u(t)}));const l=e.querySelector(".form__photo-container .drop-zone"),f=e.querySelector(".form__photo-container input[type=file]"),p=e.querySelector(".form__gallery"),m=function(e){const t=d(e);let n=document.createElement("img");if(t){const t=new FileReader;t.addEventListener("load",(function(){n.src=t.result})),t.readAsDataURL(e)}return n};f.addEventListener("change",(function(e){const t=f.files;let n=document.createDocumentFragment();for(let e=0;e<t.length;e++){let o=t[e];window.uploadFiles.photos.push(o);const r=m(o);n.appendChild(r)}p.appendChild(n)}));for(let e in i)i[e].forEach(e=>{l.addEventListener(e,a)});i.on.forEach(e=>{l.addEventListener(e,(function(){c(l)}))}),i.out.forEach(e=>{l.addEventListener(e,(function(){s(l)}))}),l.addEventListener("drop",(function(e){const t=e.dataTransfer.files;let n=document.createDocumentFragment();Array.from(t,e=>{window.uploadFiles.photos.push(e);const t=m(e);n.appendChild(t)}),p.appendChild(n)}))}(),function(){const e=document.querySelector(".notice__form"),t=e.querySelectorAll("fieldset"),n=e.querySelector(".notice__preview img").src;document.querySelector(".form__submit");window.form={able:function(){e.classList.remove("notice__form--disabled"),t.forEach(e=>e.disabled=!1)},disable:function(){e.classList.add("notice__form--disabled"),t.forEach(e=>e.disabled=!0)},reset:function(t){e.reset(),e.querySelector(".notice__preview img").src=n,e.querySelector(".form__gallery").innerHTML="",window.uploadFiles.avatar="",window.uploadFiles.photos=[],window.resetMainPin(),window.card.delete(),window.pin.clear(),window.filter.reset()}},window.form.disable(),document.querySelector(".form__reset").addEventListener("click",(function(e){e.preventDefault(),window.form.reset()}));const o=e.querySelector("input#title");o.addEventListener("invalid",(function(e){o.validity.tooShort?o.setCustomValidity("Минимальная длина заголовка - 30 символов"):o.validity.tooLong?o.setCustomValidity("Максимальная длина заголовка - 100 символов"):o.validity.valueMissing?o.setCustomValidity("Обязательное поле"):o.setCustomValidity("")}));const r=e.querySelector("input#price"),i={apartToPrice:{bungalo:0,flat:1e3,house:5e3,palace:1e4},set:function(e){r.min=this.apartToPrice[e],r.placeholder="От "+this.apartToPrice[e],r.title="Цена от "+r.min+", но не более "+r.max}},c=e.querySelector("select#type");c.addEventListener("change",(function(){i.set(c.value)})),r.addEventListener("invalid",(function(e){r.validity.badInput?r.setCustomValidity("Поле может содержать только цифры"):r.validity.rangeUnderflow?r.setCustomValidity("Минимальная цена - "+r.placeholder+" руб"):r.validity.rangeOverflow?r.setCustomValidity("Максимальная цена - 1 000 000 руб"):r.validity.valueMissing?r.setCustomValidity("Обязательное поле"):r.setCustomValidity("")}));const s=e.querySelector("select#timein"),a=e.querySelector("select#timeout");s.addEventListener("change",(function(){a.value=s.value})),a.addEventListener("change",(function(){s.value=a.value}));let u=e.querySelector("select#capacity"),d=u.querySelectorAll("option"),l=e.querySelector("select#room_number"),f={1:["1"],2:["2","1"],3:["3","2","1"],100:["0"]},p=l.value;const m=function(){d.forEach((function(e){e.disabled=!0}))},h=function(){d.forEach((e,t)=>{f[p].indexOf(e.value)>=0&&(d[t].disabled=!1)})};m(),h(),u.querySelector("option:enabled").selected=!0,l.addEventListener("change",(function(){p=l.value,m(),h(),u.querySelector("option:enabled").selected=!0}));const _=document.querySelector(".modal"),v=document.querySelector(".modal__title"),w=document.querySelector(".modal__button"),y="Данные успешно отправлены",g="При отправке данных произошла ошибка. Возможно, вы неправильно ввели данные.",E={show:function(e,t){_.classList.remove("hidden"),w.addEventListener("click",E.hide),document.addEventListener("click",E.onClickOut),document.addEventListener("keydown",E.onEscPress)},hide:function(){_.classList.add("hidden"),w.removeEventListener("click",E.hide),document.removeEventListener("keydown",E.onEscPress),document.removeEventListener("click",E.onClickOut)},onEscPress:function(e){27===e.keyCode&&E.hide()},onClickOut:function(e){document.querySelector(".modal__content").contains(e.target)||E.hide()}};e.addEventListener("submit",(function(t){t.preventDefault();const n=new FormData(e);n.append("avatar",window.uploadFiles.avatar),window.uploadFiles.photos.forEach(e=>n.append("photo",e)),window.backend.save(n,(function(e){window.form.reset(),v.textContent=y,E.show()}),(function(e){v.textContent=g,E.show(),console.log("Ошибка отправки формы. Статус ответа: "+e.status+" - "+e.statusText)}))}))}(),function(){const e=document.querySelector(".map__similar-pins"),t=document.querySelector("template").content.querySelector(".map__pin"),n=function(e){const n=t.cloneNode(!0);return n.style.left=e.location.x+"px",n.style.top=e.location.y+"px",n.querySelector("img").src="assets/"+e.author.avatar,n.querySelector("img").alt=e.offer.title,n.addEventListener("click",(function(t){window.card.show(t,e)})),n};window.pin={render:function(t){e.innerHTML="";const o=document.createDocumentFragment(),r=t.length>5?5:t.length;for(let e=0;e<r;e++)o.appendChild(n(t[e]));e.appendChild(o)},clear:function(){e.innerHTML=""}}}(),function(){const e=document.querySelector(".map"),t=document.querySelector(".map__filters-container"),n=document.querySelector("template").content.querySelector(".map__card"),o={flat:"Квартира",bungalo:"Бунгало",house:"Дом",palace:"Дворец"},r={wifi:".feature--wifi",dishwasher:".feature--dishwasher",parking:".feature--parking",washer:".feature--washer",elevator:".feature--elevator",conditioner:".feature--conditioner"},i=function(e){let t=n.cloneNode(!0);return t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__price").textContent=e.offer.price+" ₽/ночь",t.querySelector(".popup__type").textContent=o[e.offer.type],t.querySelector(".popup__text--capacity").textContent=e.offer.rooms+" комнаты для "+e.offer.guests,t.querySelector(".popup__text--time").textContent="Заезд после "+e.offer.checkin+", выезд до  "+e.offer.checkout,function(e){return Object.keys(r).filter((function(t){return e.offer.features.indexOf(t)<0}))}(e).forEach(e=>{t.querySelector(r[e]).style.display="none"}),t.querySelector(".popup__description").textContent=e.offer.description,t.querySelector(".popup__avatar").src="assets/"+e.author.avatar,t.querySelector(".popup__pictures").appendChild(function(e){let t=document.createDocumentFragment();return e.forEach((function(e){let n=document.createElement("li"),o=document.createElement("img");o.src=e,n.appendChild(o),t.appendChild(n)})),t}(e.offer.photos)),t};let c,s,a;const u=function(){s&&(e.removeChild(s),document.removeEventListener("keydown",d),c.removeEventListener("click",u)),s=""},d=function(e){window.util.onEscPress(e,u)};window.card={delete:u,show:function(n,o){u(),function(n){const o=document.createDocumentFragment();o.appendChild(i(n)),e.insertBefore(o,t)}(o);const r=n.target.closest(".map__pin");a&&a.classList.remove("map__pin--active"),(a=r).classList.add("map__pin--active"),s=e.querySelector(".map__card"),document.addEventListener("keydown",d),(c=e.querySelector(".popup .popup__close")).addEventListener("click",u)}}}();